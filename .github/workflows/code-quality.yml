name: Code Quality

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  analyze:
    name: Code Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install radon pylint

      - name: Calculate code complexity
        id: complexity
        run: |
          echo "## Code Complexity Report" > complexity-report.md
          echo "" >> complexity-report.md
          
          echo "### Cyclomatic Complexity" >> complexity-report.md
          radon cc custom_components/smartly_bridge -a -s >> complexity-report.md || true
          
          echo "" >> complexity-report.md
          echo "### Maintainability Index" >> complexity-report.md
          radon mi custom_components/smartly_bridge -s >> complexity-report.md || true
          
          cat complexity-report.md

      - name: Run Pylint
        run: |
          pylint custom_components/smartly_bridge \
            --disable=C0111,C0103,R0913,R0914 \
            --max-line-length=100 \
            --output-format=text || true

      - name: Comment PR with complexity report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('complexity-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  coverage-check:
    name: Coverage Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run tests with coverage
        run: |
          pytest tests/ \
            --cov=custom_components/smartly_bridge \
            --cov-report=term-missing \
            --cov-report=html \
            --cov-fail-under=80

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 7

  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ ! -f "README.md" ]; then
            echo "❌ README.md not found"
            exit 1
          fi
          echo "✓ README.md exists"

      - name: Check for docstrings
        run: |
          python -c "
          import ast
          import sys
          from pathlib import Path
          
          def check_docstrings(file_path):
              with open(file_path) as f:
                  tree = ast.parse(f.read())
              
              missing = []
              for node in ast.walk(tree):
                  if isinstance(node, (ast.FunctionDef, ast.ClassDef, ast.AsyncFunctionDef)):
                      if not ast.get_docstring(node) and not node.name.startswith('_'):
                          missing.append(f'{node.name} (line {node.lineno})')
              
              return missing
          
          all_missing = []
          for py_file in Path('custom_components/smartly_bridge').rglob('*.py'):
              if '__pycache__' in str(py_file):
                  continue
              missing = check_docstrings(py_file)
              if missing:
                  print(f'\n{py_file}:')
                  for item in missing:
                      print(f'  - Missing docstring: {item}')
                  all_missing.extend(missing)
          
          if all_missing:
              print(f'\n⚠ Found {len(all_missing)} functions/classes without docstrings')
          else:
              print('✓ All public functions and classes have docstrings')
          "

      - name: Check translation completeness
        run: |
          python -c "
          import json
          import sys
          
          # Load English (reference) translations
          with open('custom_components/smartly_bridge/translations/en.json') as f:
              en_trans = json.load(f)
          
          # Load other translations
          import os
          trans_dir = 'custom_components/smartly_bridge/translations'
          
          for trans_file in os.listdir(trans_dir):
              if trans_file == 'en.json' or not trans_file.endswith('.json'):
                  continue
              
              with open(os.path.join(trans_dir, trans_file)) as f:
                  other_trans = json.load(f)
              
              print(f'\nChecking {trans_file}...')
              # Simple key comparison (you can make this more sophisticated)
              if json.dumps(en_trans.keys()) != json.dumps(other_trans.keys()):
                  print(f'  ⚠ Translation keys may differ from English')
              else:
                  print(f'  ✓ Translation structure matches English')
          "
