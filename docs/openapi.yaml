openapi: 3.1.0
info:
  title: Smartly Bridge API
  description: |
    Home Assistant Custom Integration API for connecting community-level Home Assistant 
    with central management platform (Smartly Platform).
    
    ## Overview
    
    Smartly Bridge provides secure REST APIs for controlling Home Assistant entities and 
    synchronizing device states with external platforms. All entities must be tagged with 
    the `smartly` label to be accessible through this API.
    
    ## Features
    
    - **Device Control**: Execute service calls on labeled entities
    - **Structure Sync**: Get floor/area/device hierarchy
    - **State Sync**: Query current state of all labeled entities
    - **Webhook Push**: Real-time state change notifications (batched)
    - **Heartbeat**: Periodic health check notifications
    
    ## Security
    
    All requests must be authenticated using HMAC-SHA256 signature with the following headers:
    - `X-Client-Id`: Client identifier (format: `ha_[12 hex chars]`)
    - `X-Timestamp`: Unix timestamp in seconds (must be within ±30s of server time)
    - `X-Nonce`: UUID v4 (cannot be reused within 5 minutes)
    - `X-Signature`: HMAC-SHA256 hex digest
    
    ### Signature Calculation
    
    ```python
    import hashlib
    import hmac
    
    # 1. Calculate body hash
    body_json = json.dumps(request_body)
    body_hash = hashlib.sha256(body_json.encode()).hexdigest()
    
    # 2. Build signature payload
    payload = f"{method}\n{path}\n{timestamp}\n{nonce}\n{body_hash}"
    # Example: "POST\n/api/smartly/control\n1735228800\nuuid-here\nbody-hash-here"
    
    # 3. Calculate HMAC signature
    signature = hmac.new(
        client_secret.encode(),
        payload.encode(),
        hashlib.sha256
    ).hexdigest()
    ```
    
    ## Rate Limiting
    
    - **Limit**: 60 requests per minute per client
    - **Response Headers**: `X-RateLimit-Remaining`, `Retry-After`
    - **Status Code**: 429 when exceeded
    
    ## Supported Domains
    
    The following Home Assistant domains are supported:
    
    | Domain | Actions | Description |
    |--------|---------|-------------|
    | `switch` | turn_on, turn_off, toggle | Smart switches |
    | `light` | turn_on, turn_off, toggle | Smart lights |
    | `cover` | open_cover, close_cover, stop_cover, set_cover_position | Curtains, blinds |
    | `climate` | set_temperature, set_hvac_mode, set_fan_mode | AC, heaters |
    | `fan` | turn_on, turn_off, set_percentage, set_preset_mode | Fans |
    | `lock` | lock, unlock | Smart locks |
    | `scene` | turn_on | Scenes |
    | `script` | turn_on, turn_off | Scripts |
    | `automation` | trigger, turn_on, turn_off | Automations |
    
    ## Entity Labeling
    
    Entities must have the `smartly` label to be accessible:
    
    1. Go to Settings → Entities in Home Assistant
    2. Select the entity
    3. Add label: `smartly`
    
  version: 1.0.0
  contact:
    name: Smartly Bridge
    url: https://github.com/ppuff1988/smartly-bridge
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://{host}:{port}
    description: Home Assistant instance
    variables:
      host:
        default: localhost
        description: Home Assistant host
      port:
        default: "8123"
        description: Home Assistant port

security:
  - hmacAuth: []

tags:
  - name: Control
    description: Device control operations
  - name: Sync
    description: Structure and state synchronization

paths:
  /api/smartly/control:
    post:
      tags:
        - Control
      summary: Control a device
      description: |
        Execute a service call on an entity. The entity must have the `smartly` label 
        and the service must be in the allowed services whitelist.
        
        **Request Format:**
        - Content-Type: `application/json`
        - Body: JSON object containing `entity_id`, `action`, optional `service_data`, and `actor` information
        
        **Required Fields:**
        - `entity_id` (string): The entity ID to control (e.g., `switch.living_room_light`)
        - `action` (string): The service action to execute (e.g., `turn_on`, `turn_off`)
        
        **Optional Fields:**
        - `service_data` (object): Additional parameters for the service (e.g., brightness, temperature)
        - `actor` (object): Information about who initiated the action for audit logging
      operationId: controlDevice
      parameters:
        - $ref: '#/components/parameters/X-Client-Id'
        - $ref: '#/components/parameters/X-Timestamp'
        - $ref: '#/components/parameters/X-Nonce'
        - $ref: '#/components/parameters/X-Signature'
      requestBody:
        description: |
          JSON payload containing the control command. Must include entity_id and action.
          The service_data field structure depends on the entity domain and action being performed.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ControlRequest'
            examples:
              switchOn:
                summary: Turn on a switch
                value:
                  entity_id: switch.living_room_light
                  action: turn_on
                  service_data: {}
                  actor:
                    user_id: u_123
                    role: tenant
              
              lightWithBrightness:
                summary: Turn on light with brightness
                value:
                  entity_id: light.bedroom
                  action: turn_on
                  service_data:
                    brightness: 200
                  actor:
                    user_id: u_123
                    role: tenant
              
              lightWithColor:
                summary: Turn on light with RGB color
                value:
                  entity_id: light.bedroom
                  action: turn_on
                  service_data:
                    brightness: 200
                    rgb_color: [255, 0, 0]
                  actor:
                    user_id: u_123
                    role: tenant
              
              coverSetPosition:
                summary: Set cover position
                value:
                  entity_id: cover.living_room_curtain
                  action: set_cover_position
                  service_data:
                    position: 50
                  actor:
                    user_id: u_456
                    role: tenant
              
              climateSetTemperature:
                summary: Set climate temperature
                value:
                  entity_id: climate.living_room_ac
                  action: set_temperature
                  service_data:
                    temperature: 24
                  actor:
                    user_id: u_456
                    role: tenant
              
              climateSetMode:
                summary: Set HVAC mode
                value:
                  entity_id: climate.living_room_ac
                  action: set_hvac_mode
                  service_data:
                    hvac_mode: cool
                  actor:
                    user_id: u_456
                    role: tenant
              
              fanSetPercentage:
                summary: Set fan speed percentage
                value:
                  entity_id: fan.bedroom_fan
                  action: set_percentage
                  service_data:
                    percentage: 75
                  actor:
                    user_id: u_789
                    role: tenant
              
              lockDoor:
                summary: Lock a door
                value:
                  entity_id: lock.front_door
                  action: lock
                  service_data: {}
                  actor:
                    user_id: u_789
                    role: tenant
              
              triggerAutomation:
                summary: Trigger an automation
                value:
                  entity_id: automation.motion_light
                  action: trigger
                  service_data:
                    skip_condition: true
                  actor:
                    user_id: u_admin
                    role: admin
      responses:
        '200':
          description: Control action executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ControlResponse'
              example:
                success: true
                entity_id: switch.room_101_light
                action: turn_on
                new_state: "on"
                new_attributes:
                  brightness: 255
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidJson:
                  value:
                    error: invalid_json
                missingFields:
                  value:
                    error: missing_required_fields
        '401':
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingHeaders:
                  value:
                    error: missing_headers
                invalidTimestamp:
                  value:
                    error: invalid_timestamp
                nonceReused:
                  value:
                    error: nonce_reused
                invalidSignature:
                  value:
                    error: invalid_signature
                ipNotAllowed:
                  value:
                    error: ip_not_allowed
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                entityNotAllowed:
                  value:
                    error: entity_not_allowed
                serviceNotAllowed:
                  value:
                    error: service_not_allowed
        '429':
          description: Rate limited
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds to wait before retrying
            X-RateLimit-Remaining:
              schema:
                type: integer
              description: Number of requests remaining
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: rate_limited
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                integrationNotConfigured:
                  value:
                    error: integration_not_configured
                serviceCallFailed:
                  value:
                    error: service_call_failed

  /api/smartly/sync/structure:
    get:
      tags:
        - Sync
      summary: Get structure hierarchy
      description: |
        Returns the complete structure hierarchy including floors, areas, devices, 
        and entities that have the `smartly` label. Does not include state information.
      operationId: syncStructure
      parameters:
        - $ref: '#/components/parameters/X-Client-Id'
        - $ref: '#/components/parameters/X-Timestamp'
        - $ref: '#/components/parameters/X-Nonce'
        - $ref: '#/components/parameters/X-Signature'
      responses:
        '200':
          description: Structure retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StructureResponse'
              example:
                floors:
                  - id: floor_1
                    name: 1F
                    areas:
                      - id: area_101
                        name: Room 101
                        devices:
                          - id: device_abc123
                            name: Smart Switch
                            entities:
                              - entity_id: switch.room_101_light
                                domain: switch
                                name: Light
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/smartly/sync/states:
    get:
      tags:
        - Sync
      summary: Get all entity states
      description: |
        Returns the current state of all entities that have the `smartly` label.
        Useful for initial sync or state reconciliation.
      operationId: syncStates
      parameters:
        - $ref: '#/components/parameters/X-Client-Id'
        - $ref: '#/components/parameters/X-Timestamp'
        - $ref: '#/components/parameters/X-Nonce'
        - $ref: '#/components/parameters/X-Signature'
      responses:
        '200':
          description: States retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatesResponse'
              example:
                states:
                  - entity_id: switch.room_101_light
                    state: "on"
                    attributes:
                      friendly_name: Room 101 Light
                      brightness: 255
                    last_changed: "2025-12-17T10:30:00+00:00"
                    last_updated: "2025-12-17T10:30:00+00:00"
                count: 1
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    hmacAuth:
      type: apiKey
      in: header
      name: X-Signature
      description: |
        HMAC-SHA256 signature of the request. The signature is calculated as:
        ```
        payload = METHOD + "\n" + PATH + "\n" + TIMESTAMP + "\n" + NONCE + "\n" + SHA256(BODY)
        signature = HMAC-SHA256(client_secret, payload)
        ```

  parameters:
    X-Client-Id:
      name: X-Client-Id
      in: header
      required: true
      schema:
        type: string
        pattern: '^ha_[a-f0-9]{12}$'
        example: ha_abc123def456
      description: Client ID generated during integration setup

    X-Timestamp:
      name: X-Timestamp
      in: header
      required: true
      schema:
        type: integer
        format: int64
        example: 1702800000
      description: Unix timestamp (seconds). Must be within ±30 seconds of server time.

    X-Nonce:
      name: X-Nonce
      in: header
      required: true
      schema:
        type: string
        format: uuid
        example: 550e8400-e29b-41d4-a716-446655440000
      description: Unique identifier for request. Cannot be reused within 5 minutes.

    X-Signature:
      name: X-Signature
      in: header
      required: true
      schema:
        type: string
        pattern: '^[a-f0-9]{64}$'
        example: a1b2c3d4e5f6...
      description: HMAC-SHA256 signature of the request

  schemas:
    ControlRequest:
      type: object
      description: |
        Request body for controlling a Home Assistant entity.
        
        **Example JSON:**
        ```json
        {
          "entity_id": "light.bedroom",
          "action": "turn_on",
          "service_data": {
            "brightness": 200,
            "rgb_color": [255, 0, 0]
          },
          "actor": {
            "user_id": "u_123",
            "role": "tenant"
          }
        }
        ```
      required:
        - entity_id
        - action
      properties:
        entity_id:
          type: string
          description: |
            The entity ID to control. Must have the `smartly` label in Home Assistant.
            Format: `domain.entity_name` (e.g., `switch.living_room_light`, `light.bedroom`)
          example: switch.room_101_light
          pattern: '^[a-z_]+\.[a-z0-9_]+$'
        action:
          type: string
          description: |
            The service action to execute. Available actions depend on the entity domain.
            
            **Common actions by domain:**
            - switch/light: turn_on, turn_off, toggle
            - cover: open_cover, close_cover, stop_cover, set_cover_position
            - climate: set_temperature, set_hvac_mode, set_fan_mode
            - fan: turn_on, turn_off, set_percentage, set_preset_mode
            - lock: lock, unlock
            - automation: trigger, turn_on, turn_off
          example: turn_on
          enum:
            - turn_on
            - turn_off
            - toggle
            - open_cover
            - close_cover
            - stop_cover
            - set_cover_position
            - set_temperature
            - set_hvac_mode
            - set_fan_mode
            - set_percentage
            - set_preset_mode
            - lock
            - unlock
            - trigger
        service_data:
          type: object
          description: |
            Optional parameters for the service call. The structure varies by domain and action.
            Can be an empty object `{}` if no additional parameters are needed.
            
            **Examples by domain:**
            
            **Light:**
            ```json
            {
              "brightness": 255,
              "rgb_color": [255, 0, 0],
              "transition": 2
            }
            ```
            
            **Cover:**
            ```json
            {
              "position": 50
            }
            ```
            
            **Climate:**
            ```json
            {
              "temperature": 24,
              "hvac_mode": "cool"
            }
            ```
            
            **Fan:**
            ```json
            {
              "percentage": 75
            }
            ```
            
            **Common parameters by domain:**
            
            - **light**: brightness (0-255), rgb_color ([R, G, B]), color_temp (mireds), transition (seconds)
            - **cover**: position (0-100)
            - **climate**: temperature (float), hvac_mode (string), fan_mode (string)
            - **fan**: percentage (0-100), preset_mode (string)
            - **lock**: code (string)
            - **automation**: skip_condition (boolean)
          additionalProperties: true
          examples:
            - brightness: 255
            - rgb_color: [255, 0, 0]
            - position: 50
            - temperature: 24
        actor:
          $ref: '#/components/schemas/Actor'

    Actor:
      type: object
      description: Information about who initiated the action (for audit logging)
      properties:
        user_id:
          type: string
          description: Platform user ID
          example: u_123
        role:
          type: string
          description: User's role
          example: room_admin

    ControlResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether the action was successful
          example: true
        entity_id:
          type: string
          description: The entity ID that was controlled
          example: switch.room_101_light
        action:
          type: string
          description: The action that was executed
          example: turn_on
        new_state:
          type: string
          nullable: true
          description: The new state of the entity after the action
          example: "on"
        new_attributes:
          type: object
          nullable: true
          description: The new attributes of the entity after the action
          additionalProperties: true
          example:
            brightness: 255

    StructureResponse:
      type: object
      properties:
        floors:
          type: array
          items:
            $ref: '#/components/schemas/Floor'

    Floor:
      type: object
      properties:
        id:
          type: string
          description: Floor ID
          example: floor_1
        name:
          type: string
          description: Floor name
          example: 1F
        areas:
          type: array
          items:
            $ref: '#/components/schemas/Area'

    Area:
      type: object
      properties:
        id:
          type: string
          description: Area ID
          example: area_101
        name:
          type: string
          description: Area name
          example: Room 101
        devices:
          type: array
          items:
            $ref: '#/components/schemas/Device'

    Device:
      type: object
      properties:
        id:
          type: string
          description: Device ID
          example: device_abc123
        name:
          type: string
          description: Device name
          example: Smart Switch
        entities:
          type: array
          items:
            $ref: '#/components/schemas/Entity'

    Entity:
      type: object
      properties:
        entity_id:
          type: string
          description: Entity ID
          example: switch.room_101_light
        domain:
          type: string
          description: Entity domain
          example: switch
          enum:
            - switch
            - light
            - cover
            - climate
            - fan
            - lock
            - scene
            - script
            - automation
        name:
          type: string
          description: Entity friendly name
          example: Light

    StatesResponse:
      type: object
      properties:
        states:
          type: array
          items:
            $ref: '#/components/schemas/EntityState'
        count:
          type: integer
          description: Number of entities returned
          example: 1

    EntityState:
      type: object
      properties:
        entity_id:
          type: string
          description: Entity ID
          example: switch.room_101_light
        state:
          type: string
          description: Current state value
          example: "on"
        attributes:
          type: object
          description: Entity attributes
          additionalProperties: true
          example:
            friendly_name: Room 101 Light
            brightness: 255
        last_changed:
          type: string
          format: date-time
          description: When the state last changed
          example: "2025-12-17T10:30:00+00:00"
        last_updated:
          type: string
          format: date-time
          description: When the state was last updated
          example: "2025-12-17T10:30:00+00:00"

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error code
          example: invalid_signature
          enum:
            - invalid_json
            - missing_required_fields
            - missing_headers
            - invalid_timestamp
            - nonce_reused
            - invalid_signature
            - ip_not_allowed
            - entity_not_allowed
            - service_not_allowed
            - rate_limited
            - integration_not_configured
            - service_call_failed

    # Service Data Schemas for different domains
    LightServiceData:
      type: object
      description: Service data for light domain
      properties:
        brightness:
          type: integer
          minimum: 0
          maximum: 255
          description: Brightness level (0-255)
        rgb_color:
          type: array
          items:
            type: integer
            minimum: 0
            maximum: 255
          minItems: 3
          maxItems: 3
          description: RGB color array [R, G, B]
          example: [255, 0, 0]
        color_temp:
          type: integer
          minimum: 153
          maximum: 500
          description: Color temperature in mireds
        kelvin:
          type: integer
          minimum: 2000
          maximum: 6500
          description: Color temperature in Kelvin
        hs_color:
          type: array
          items:
            type: number
          minItems: 2
          maxItems: 2
          description: Hue and saturation [0-360, 0-100]
        transition:
          type: integer
          minimum: 0
          description: Transition time in seconds

    CoverServiceData:
      type: object
      description: Service data for cover domain
      properties:
        position:
          type: integer
          minimum: 0
          maximum: 100
          description: Position percentage (0=closed, 100=open)
        tilt_position:
          type: integer
          minimum: 0
          maximum: 100
          description: Tilt position for blinds

    ClimateServiceData:
      type: object
      description: Service data for climate domain
      properties:
        temperature:
          type: number
          description: Target temperature
        target_temp_high:
          type: number
          description: Target high temperature (for heat_cool mode)
        target_temp_low:
          type: number
          description: Target low temperature (for heat_cool mode)
        hvac_mode:
          type: string
          enum: [off, heat, cool, heat_cool, auto, dry, fan_only]
          description: HVAC mode
        fan_mode:
          type: string
          enum: [auto, low, medium, high, middle, focus, diffuse]
          description: Fan mode
        preset_mode:
          type: string
          enum: [eco, away, boost, comfort, home, sleep]
          description: Preset mode
        swing_mode:
          type: string
          enum: [off, vertical, horizontal, both]
          description: Swing mode

    FanServiceData:
      type: object
      description: Service data for fan domain
      properties:
        percentage:
          type: integer
          minimum: 0
          maximum: 100
          description: Fan speed percentage
        preset_mode:
          type: string
          enum: [sleep, normal, turbo, natural]
          description: Preset mode
        direction:
          type: string
          enum: [forward, reverse]
          description: Fan rotation direction
        oscillating:
          type: boolean
          description: Enable oscillation

    LockServiceData:
      type: object
      description: Service data for lock domain
      properties:
        code:
          type: string
          description: Unlock code (optional)

    AutomationServiceData:
      type: object
      description: Service data for automation domain
      properties:
        skip_condition:
          type: boolean
          description: Skip condition check and execute actions directly

    ScriptServiceData:
      type: object
      description: Service data for script domain
      properties:
        variables:
          type: object
          additionalProperties: true
          description: Variables to pass to the script

    # Webhook Schemas
    WebhookEventsPayload:
      type: object
      properties:
        events:
          type: array
          items:
            $ref: '#/components/schemas/StateChangedEvent'

    StateChangedEvent:
      type: object
      properties:
        event_type:
          type: string
          const: state_changed
        data:
          type: object
          properties:
            entity_id:
              type: string
            old_state:
              $ref: '#/components/schemas/StateData'
            new_state:
              $ref: '#/components/schemas/StateData'

    StateData:
      type: object
      properties:
        state:
          type: string
        attributes:
          type: object
          additionalProperties: true
        last_changed:
          type: string
          format: date-time
        last_updated:
          type: string
          format: date-time

    HeartbeatPayload:
      type: object
      properties:
        event_type:
          type: string
          const: heartbeat
        timestamp:
          type: string
          format: date-time

  responses:
    UnauthorizedError:
      description: Authentication failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            missingHeaders:
              value:
                error: missing_headers
            invalidSignature:
              value:
                error: invalid_signature

    RateLimitError:
      description: Rate limited
      headers:
        Retry-After:
          schema:
            type: integer
          description: Seconds to wait before retrying
        X-RateLimit-Remaining:
          schema:
            type: integer
          description: Number of requests remaining
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: rate_limited

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: integration_not_configured

webhooks:
  stateChanged:
    post:
      summary: State change notification
      description: |
        Sent from Bridge to Platform when entity states change.
        Events are batched and sent at 500ms intervals.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookEventsPayload'
            example:
              events:
                - event_type: state_changed
                  data:
                    entity_id: switch.room_101_light
                    old_state:
                      state: "off"
                      attributes: {}
                      last_changed: "2025-12-17T09:00:00+00:00"
                      last_updated: "2025-12-17T09:00:00+00:00"
                    new_state:
                      state: "on"
                      attributes:
                        brightness: 255
                      last_changed: "2025-12-17T10:30:00+00:00"
                      last_updated: "2025-12-17T10:30:00+00:00"
      responses:
        '200':
          description: Events received successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true

  heartbeat:
    post:
      summary: Heartbeat notification
      description: |
        Sent from Bridge to Platform every 60 seconds to indicate the bridge is online.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HeartbeatPayload'
            example:
              event_type: heartbeat
              timestamp: "2025-12-17T10:30:00.000000+00:00"
      responses:
        '200':
          description: Heartbeat received successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true


